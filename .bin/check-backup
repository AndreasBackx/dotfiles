#!/usr/bin/env zsh

set -e

function is_timer_active() {
    if systemctl is-active --quiet create-backup.timer; then
        true
    else
        false
    fi
}

function is_service_active() {
    if systemctl is-active --quiet create-backup.service; then
        true
    else
        false
    fi
}

function is_service_failed() {
    if systemctl is-failed --quiet create-backup.service; then
        true
    else
        false
    fi
}

function is_timer_waiting() {
    timer_status=`systemctl status --quiet create-backup.timer`
    if  [[ $timer_status == *"Active: active (waiting)"* ]]; then
        true
    else
        false
    fi
}

function status() {
    if is_timer_active; then
        if is_service_active; then
            echo "%{F#CECECE}%{F-}"
        else
            if is_service_failed; then
                echo "%{F#6E6E6E}%{F-}"
            else
                echo "%{F#6E6E6E}%{F-}"
            fi
        fi
    else
        echo "%{F#6E6E6E}%{F-}"
    fi
}

case "$1" in
    status)
        status
        ;;
    update)
        polybar-msg hook check-backup 1 &> /dev/null
        ;;
    start)
        if ! [[ is_timer_active ]]; then
            sudo systemctl start create-backup.timer
        fi
        sudo systemctl start create-backup.service
        ;;
    *)
        echo "Usage: $0 {status|activate}"
        exit 1
        ;;
esac
